"""Tests for {{ name | pascal_case }}Handler."""

import uuid
from unittest.mock import AsyncMock, MagicMock, patch

import pytest

from {{ module_name }}.{{ name | snake_case }}_handler import {{ name | pascal_case }}Handler


@pytest.fixture
def handler():
    return {{ name | pascal_case }}Handler()


@pytest.fixture
def context():
    ctx = MagicMock()
    ctx.task_uuid = uuid.uuid4()
    ctx.step_uuid = uuid.uuid4()
    ctx.input_data = {"endpoint": "/users/1"}
    ctx.step_config = {"base_url": "{{ base_url }}"}
    ctx.retry_count = 0
    ctx.max_retries = 3
    return ctx


class TestCall:
    @pytest.mark.asyncio
    async def test_returns_success_on_200(self, handler, context):
        mock_response = MagicMock()
        mock_response.is_success = True
        mock_response.status_code = 200
        mock_response.json.return_value = {"id": 1, "name": "Test"}

        with patch("httpx.AsyncClient") as mock_client:
            mock_client.return_value.__aenter__ = AsyncMock(return_value=mock_client.return_value)
            mock_client.return_value.__aexit__ = AsyncMock(return_value=False)
            mock_client.return_value.get = AsyncMock(return_value=mock_response)

            result = await handler.call(context)

        assert result.success is True
        assert result.result["id"] == 1

    @pytest.mark.asyncio
    async def test_returns_retryable_failure_on_500(self, handler, context):
        mock_response = MagicMock()
        mock_response.is_success = False
        mock_response.status_code = 500

        with patch("httpx.AsyncClient") as mock_client:
            mock_client.return_value.__aenter__ = AsyncMock(return_value=mock_client.return_value)
            mock_client.return_value.__aexit__ = AsyncMock(return_value=False)
            mock_client.return_value.get = AsyncMock(return_value=mock_response)

            result = await handler.call(context)

        assert result.success is False
        assert result.retryable is True
