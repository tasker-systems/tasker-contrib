# Bleeding Edge CI
#
# Tests tasker-contrib templates against the latest tasker-core main branch.
# Builds tasker-ctl from source and runs full template validation.
#
# Triggered by:
# 1. Repository dispatch from tasker-core (on merge to main)
# 2. Manual workflow dispatch
# 3. Scheduled nightly run

name: Bleeding Edge

on:
  repository_dispatch:
    types: [tasker-core-updated]

  workflow_dispatch:
    inputs:
      tasker_core_ref:
        description: 'tasker-core ref to test against (default: main)'
        required: false
        default: 'main'

  schedule:
    - cron: '0 4 * * *'

concurrency:
  group: bleeding-edge-${{ github.ref }}
  cancel-in-progress: true

env:
  TASKER_CORE_REF: ${{ github.event.inputs.tasker_core_ref || github.event.client_payload.ref || 'main' }}

jobs:
  # ==========================================================================
  # Build tasker-ctl from specified tasker-core ref
  # ==========================================================================
  build-tasker-ctl:
    name: Build tasker-ctl
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      core-sha: ${{ steps.sha.outputs.sha }}
    steps:
      - name: Checkout tasker-contrib
        uses: actions/checkout@v4
        with:
          path: tasker-contrib

      - name: Build tasker-ctl
        uses: ./tasker-contrib/.github/actions/build-tasker-core
        with:
          tasker-core-ref: ${{ env.TASKER_CORE_REF }}

      - name: Record tasker-core SHA
        id: sha
        run: |
          cd tasker-core
          echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

  # ==========================================================================
  # Full template validation
  # ==========================================================================
  validate-and-test:
    name: Validate & Test All Templates
    needs: build-tasker-ctl
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Language toolchains for syntax checking
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install PyYAML
        run: pip install pyyaml

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Download tasker-ctl
        uses: actions/download-artifact@v4
        with:
          name: tasker-ctl
          path: bin

      - name: Make binary executable
        run: chmod +x bin/tasker-ctl

      - name: Validate all plugins
        env:
          TASKER_CTL: ${{ github.workspace }}/bin/tasker-ctl
        run: ./scripts/validate-plugins.sh

      - name: Test all templates
        env:
          TASKER_CTL: ${{ github.workspace }}/bin/tasker-ctl
        run: ./scripts/test-templates.sh

  # ==========================================================================
  # Report
  # ==========================================================================
  report:
    name: Report Results
    needs: [build-tasker-ctl, validate-and-test]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate report
        run: |
          echo "## Bleeding Edge Build Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**tasker-core ref**: \`${{ env.TASKER_CORE_REF }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "**tasker-core SHA**: \`${{ needs.build-tasker-ctl.outputs.core-sha }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Job | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Build tasker-ctl | ${{ needs.build-tasker-ctl.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Validate & Test | ${{ needs.validate-and-test.result }} |" >> "$GITHUB_STEP_SUMMARY"

      - uses: actions/checkout@v4
        if: contains(needs.*.result, 'failure')

      - name: Create issue on failure
        if: contains(needs.*.result, 'failure')
        uses: actions/github-script@v7
        with:
          script: |
            const ref = process.env.TASKER_CORE_REF;
            const sha = '${{ needs.build-tasker-ctl.outputs.core-sha }}';

            const title = `Bleeding edge template validation failed (tasker-core ${ref})`;
            const body = [
              '## Bleeding Edge Template Validation Failure',
              '',
              `**tasker-core ref:** \`${ref}\``,
              `**tasker-core SHA:** \`${sha}\``,
              '',
              '**Results:**',
              `- Build tasker-ctl: ${{ needs.build-tasker-ctl.result }}`,
              `- Validate & Test: ${{ needs.validate-and-test.result }}`,
              '',
              `**Workflow run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              '',
              'Please investigate and update tasker-contrib templates as needed.',
            ].join('\n');

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'bleeding-edge-failure'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['bleeding-edge-failure', 'automated']
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `New failure detected:\n\n${body}`
              });
            }
