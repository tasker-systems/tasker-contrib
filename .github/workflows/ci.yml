# Tasker Contrib CI Strategy
#
# Unlike tasker-core which runs holistic CI for coherence, tasker-contrib uses
# path-based CI to only run relevant tests when specific directories change.
#
# CI Modes:
# 1. PR/Merge (ci.yml): Path-based, runs against pinned dependencies
# 2. Bleeding Edge (bleeding-edge.yml): Triggered by tasker-core, tests latest
# 3. Upstream Check (upstream-check.yml): Daily check for new tasker-core releases
#
# Versioning Strategy:
# - tasker-contrib packages pin to tasker-core semver ranges
# - Bleeding-edge builds catch compatibility issues early
# - Upstream checks notify when new versions are available

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Change Detection
  # ==========================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      rails: ${{ steps.filter.outputs.rails }}
      python: ${{ steps.filter.outputs.python }}
      typescript: ${{ steps.filter.outputs.typescript }}
      rust: ${{ steps.filter.outputs.rust }}
      ops: ${{ steps.filter.outputs.ops }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            rails:
              - 'rails/**'
              - '.github/workflows/ci.yml'
            python:
              - 'python/**'
              - '.github/workflows/ci.yml'
            typescript:
              - 'typescript/**'
              - '.github/workflows/ci.yml'
            rust:
              - 'rust/**'
              - '.github/workflows/ci.yml'
            ops:
              - 'ops/**'
              - '.github/workflows/ci.yml'
            docs:
              - 'docs/**'
              - '*.md'
              - '.github/workflows/ci.yml'

  # ==========================================================================
  # Rails CI
  # ==========================================================================
  rails:
    name: Rails
    needs: changes
    if: needs.changes.outputs.rails == 'true'
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        ruby: ['3.2', '3.3']
        rails: ['7.0', '7.1', '7.2']
    
    services:
      postgres:
        image: quay.io/tembo/pg17-pgmq:latest
        env:
          POSTGRES_USER: tasker
          POSTGRES_PASSWORD: tasker
          POSTGRES_DB: tasker_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: true
          working-directory: rails/tasker-contrib-rails
      
      # Build tasker-core-rb from source (bleeding edge) or use published gem
      - name: Setup tasker-core-rb
        run: |
          # For now, we'll use path dependency to local build
          # Once published, this will use the gem from RubyGems
          echo "tasker-core-rb setup placeholder"
      
      - name: Run tests
        working-directory: rails/tasker-contrib-rails
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_test
          RAILS_VERSION: ${{ matrix.rails }}
        run: |
          bundle install
          bundle exec rspec --format progress
      
      - name: Lint
        working-directory: rails/tasker-contrib-rails
        run: |
          bundle exec rubocop --parallel

  # ==========================================================================
  # Python CI
  # ==========================================================================
  python:
    name: Python
    needs: changes
    if: needs.changes.outputs.python == 'true'
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python: ['3.11', '3.12']
    
    services:
      postgres:
        image: quay.io/tembo/pg17-pgmq:latest
        env:
          POSTGRES_USER: tasker
          POSTGRES_PASSWORD: tasker
          POSTGRES_DB: tasker_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
      
      - name: Setup tasker-core-py
        run: |
          # For now, placeholder
          echo "tasker-core-py setup placeholder"
      
      - name: Install dependencies
        working-directory: python/tasker-contrib-fastapi
        run: |
          uv sync
      
      - name: Run tests
        working-directory: python/tasker-contrib-fastapi
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_test
        run: |
          uv run pytest
      
      - name: Lint
        working-directory: python/tasker-contrib-fastapi
        run: |
          uv run ruff check .
          uv run ruff format --check .

  # ==========================================================================
  # TypeScript CI
  # ==========================================================================
  typescript:
    name: TypeScript
    needs: changes
    if: needs.changes.outputs.typescript == 'true'
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: quay.io/tembo/pg17-pgmq:latest
        env:
          POSTGRES_USER: tasker
          POSTGRES_PASSWORD: tasker
          POSTGRES_DB: tasker_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Setup tasker-core-ts
        run: |
          # For now, placeholder
          echo "tasker-core-ts setup placeholder"
      
      - name: Install dependencies
        working-directory: typescript/tasker-contrib-bun
        run: |
          bun install
      
      - name: Run tests
        working-directory: typescript/tasker-contrib-bun
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_test
        run: |
          bun test
      
      - name: Lint
        working-directory: typescript/tasker-contrib-bun
        run: |
          bun run lint

  # ==========================================================================
  # Rust CI
  # ==========================================================================
  rust:
    name: Rust
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: quay.io/tembo/pg17-pgmq:latest
        env:
          POSTGRES_USER: tasker
          POSTGRES_PASSWORD: tasker
          POSTGRES_DB: tasker_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust -> target
      
      - name: Check formatting
        working-directory: rust/tasker-contrib-axum
        run: cargo fmt --check
      
      - name: Clippy
        working-directory: rust/tasker-contrib-axum
        run: cargo clippy --all-targets -- -D warnings
      
      - name: Test
        working-directory: rust/tasker-contrib-axum
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_test
        run: cargo test

  # ==========================================================================
  # Ops Validation
  # ==========================================================================
  ops:
    name: Ops Validation
    needs: changes
    if: needs.changes.outputs.ops == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate Docker Compose files
        run: |
          for file in ops/docker/*/docker-compose*.yml; do
            if [ -f "$file" ]; then
              echo "Validating $file"
              docker compose -f "$file" config > /dev/null
            fi
          done
      
      - name: Lint Helm charts
        run: |
          if command -v helm &> /dev/null; then
            for chart in ops/helm/*/; do
              if [ -f "${chart}Chart.yaml" ]; then
                echo "Linting $chart"
                helm lint "$chart"
              fi
            done
          fi
      
      - name: Validate Terraform
        run: |
          if command -v terraform &> /dev/null; then
            for module in ops/terraform/*/; do
              if [ -f "${module}main.tf" ]; then
                echo "Validating $module"
                terraform -chdir="$module" init -backend=false
                terraform -chdir="$module" validate
              fi
            done
          fi

  # ==========================================================================
  # Documentation
  # ==========================================================================
  docs:
    name: Documentation
    needs: changes
    if: needs.changes.outputs.docs == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check.json'
        continue-on-error: true  # Don't fail on dead links for now

  # ==========================================================================
  # Summary
  # ==========================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [changes, rails, python, typescript, rust, ops, docs]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rails | ${{ needs.rails.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python | ${{ needs.python.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | ${{ needs.typescript.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rust | ${{ needs.rust.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ops | ${{ needs.ops.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs | ${{ needs.docs.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
      
      - name: Fail if any job failed
        if: contains(needs.*.result, 'failure')
        run: exit 1
