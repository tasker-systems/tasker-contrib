# Tasker Contrib CI — Template Validation
#
# Validates plugin manifests and generates + syntax-checks all templates.
# No database or services required — tasker-ctl is a pure CLI tool.
#
# Strategy:
# 1. Install tasker-ctl from crates.io
# 2. Validate all plugin manifests
# 3. Per-language: generate templates and syntax-check output files

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Change Detection
  # ==========================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      templates: ${{ steps.filter.outputs.templates }}
      rails-templates: ${{ steps.filter.outputs.rails-templates }}
      python-templates: ${{ steps.filter.outputs.python-templates }}
      typescript-templates: ${{ steps.filter.outputs.typescript-templates }}
      rust-templates: ${{ steps.filter.outputs.rust-templates }}
      ops-templates: ${{ steps.filter.outputs.ops-templates }}
      docs: ${{ steps.filter.outputs.docs }}
      scripts: ${{ steps.filter.outputs.scripts }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            templates:
              - '*/tasker-cli-plugin/**'
              - 'scripts/**'
              - '.github/workflows/ci.yml'
            rails-templates:
              - 'rails/tasker-cli-plugin/**'
            python-templates:
              - 'python/tasker-cli-plugin/**'
            typescript-templates:
              - 'typescript/tasker-cli-plugin/**'
            rust-templates:
              - 'rust/tasker-cli-plugin/**'
            ops-templates:
              - 'ops/tasker-cli-plugin/**'
            docs:
              - 'docs/**'
              - '*.md'
            scripts:
              - 'scripts/**'

  # ==========================================================================
  # Build tasker-ctl
  # ==========================================================================
  build-tasker-ctl:
    name: Install tasker-ctl
    needs: changes
    if: needs.changes.outputs.templates == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: cargo-tasker-ctl-${{ runner.os }}-${{ hashFiles('**/upstream-versions.json') }}
          restore-keys: cargo-tasker-ctl-${{ runner.os }}-

      - name: Install tasker-ctl from crates.io
        run: cargo install tasker-ctl

      - name: Upload tasker-ctl binary
        uses: actions/upload-artifact@v4
        with:
          name: tasker-ctl
          path: ~/.cargo/bin/tasker-ctl
          retention-days: 1

  # ==========================================================================
  # Validate all plugin manifests
  # ==========================================================================
  validate-plugins:
    name: Validate Plugins
    needs: build-tasker-ctl
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download tasker-ctl
        uses: actions/download-artifact@v4
        with:
          name: tasker-ctl
          path: bin

      - name: Make binary executable
        run: chmod +x bin/tasker-ctl

      - name: Validate all plugins
        env:
          TASKER_CTL: ${{ github.workspace }}/bin/tasker-ctl
        run: ./scripts/validate-plugins.sh

  # ==========================================================================
  # Rails template tests
  # ==========================================================================
  test-ruby-templates:
    name: Ruby Templates
    needs: [changes, build-tasker-ctl]
    if: needs.changes.outputs.rails-templates == 'true' || needs.changes.outputs.templates == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'

      - name: Download tasker-ctl
        uses: actions/download-artifact@v4
        with:
          name: tasker-ctl
          path: bin

      - name: Make binary executable
        run: chmod +x bin/tasker-ctl

      - name: Test Rails templates
        env:
          TASKER_CTL: ${{ github.workspace }}/bin/tasker-ctl
        run: ./scripts/test-templates.sh --plugin tasker-contrib-rails

  # ==========================================================================
  # Python template tests
  # ==========================================================================
  test-python-templates:
    name: Python Templates
    needs: [changes, build-tasker-ctl]
    if: needs.changes.outputs.python-templates == 'true' || needs.changes.outputs.templates == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Download tasker-ctl
        uses: actions/download-artifact@v4
        with:
          name: tasker-ctl
          path: bin

      - name: Make binary executable
        run: chmod +x bin/tasker-ctl

      - name: Test Python templates
        env:
          TASKER_CTL: ${{ github.workspace }}/bin/tasker-ctl
        run: ./scripts/test-templates.sh --plugin tasker-contrib-python

  # ==========================================================================
  # TypeScript template tests
  # ==========================================================================
  test-typescript-templates:
    name: TypeScript Templates
    needs: [changes, build-tasker-ctl]
    if: needs.changes.outputs.typescript-templates == 'true' || needs.changes.outputs.templates == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Download tasker-ctl
        uses: actions/download-artifact@v4
        with:
          name: tasker-ctl
          path: bin

      - name: Make binary executable
        run: chmod +x bin/tasker-ctl

      - name: Test TypeScript templates
        env:
          TASKER_CTL: ${{ github.workspace }}/bin/tasker-ctl
        run: ./scripts/test-templates.sh --plugin tasker-contrib-typescript

  # ==========================================================================
  # Rust template tests
  # ==========================================================================
  test-rust-templates:
    name: Rust Templates
    needs: [changes, build-tasker-ctl]
    if: needs.changes.outputs.rust-templates == 'true' || needs.changes.outputs.templates == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Download tasker-ctl
        uses: actions/download-artifact@v4
        with:
          name: tasker-ctl
          path: bin

      - name: Make binary executable
        run: chmod +x bin/tasker-ctl

      - name: Test Rust templates
        env:
          TASKER_CTL: ${{ github.workspace }}/bin/tasker-ctl
        run: ./scripts/test-templates.sh --plugin tasker-contrib-rust

  # ==========================================================================
  # Ops template tests
  # ==========================================================================
  test-ops-templates:
    name: Ops Templates
    needs: [changes, build-tasker-ctl]
    if: needs.changes.outputs.ops-templates == 'true' || needs.changes.outputs.templates == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Download tasker-ctl
        uses: actions/download-artifact@v4
        with:
          name: tasker-ctl
          path: bin

      - name: Make binary executable
        run: chmod +x bin/tasker-ctl

      - name: Test Ops templates
        env:
          TASKER_CTL: ${{ github.workspace }}/bin/tasker-ctl
        run: ./scripts/test-templates.sh --plugin tasker-contrib-ops

  # ==========================================================================
  # CI Sanity Check
  # ==========================================================================
  ci-sanity-check:
    name: CI Sanity Check
    needs: changes
    if: needs.changes.outputs.scripts == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Install actionlint
        run: |
          ACTIONLINT_VERSION="1.7.7"
          curl -sL "https://github.com/rhysd/actionlint/releases/download/v${ACTIONLINT_VERSION}/actionlint_${ACTIONLINT_VERSION}_linux_amd64.tar.gz" | tar xz -C /usr/local/bin actionlint

      - name: Run CI sanity check
        run: ./scripts/ci-sanity-check.sh

  # ==========================================================================
  # Documentation
  # ==========================================================================
  docs:
    name: Documentation
    needs: changes
    if: needs.changes.outputs.docs == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check.json'
        continue-on-error: true

  # ==========================================================================
  # Summary
  # ==========================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs:
      - changes
      - validate-plugins
      - test-ruby-templates
      - test-python-templates
      - test-typescript-templates
      - test-rust-templates
      - test-ops-templates
      - ci-sanity-check
      - docs
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## CI Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Job | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Validate Plugins | ${{ needs.validate-plugins.result || 'skipped' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Ruby Templates | ${{ needs.test-ruby-templates.result || 'skipped' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Python Templates | ${{ needs.test-python-templates.result || 'skipped' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| TypeScript Templates | ${{ needs.test-typescript-templates.result || 'skipped' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Rust Templates | ${{ needs.test-rust-templates.result || 'skipped' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Ops Templates | ${{ needs.test-ops-templates.result || 'skipped' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| CI Sanity Check | ${{ needs.ci-sanity-check.result || 'skipped' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Docs | ${{ needs.docs.result || 'skipped' }} |" >> "$GITHUB_STEP_SUMMARY"

      - name: Fail if any job failed
        if: contains(needs.*.result, 'failure')
        run: exit 1
