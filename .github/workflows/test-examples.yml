# Test Example Applications
#
# Runs integration tests for all four example apps against
# docker-compose infrastructure with published Tasker packages.
#
# Strategy: single job with sequential app testing to share
# the docker-compose services and avoid resource contention.

name: Test Examples

on:
  push:
    branches: [main]
    paths:
      - 'examples/**'
      - '.github/workflows/test-examples.yml'
  pull_request:
    branches: [main]
    paths:
      - 'examples/**'
      - '.github/workflows/test-examples.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-examples:
    name: Example App Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker
      RABBITMQ_URL: amqp://tasker:tasker@localhost:5672/%2F
      ORCHESTRATION_URL: http://localhost:8080
      TASKER_API_KEY: test-api-key-full-access
      TASKER_ENV: development
      RUST_LOG: info

    steps:
      # ================================================================
      # Setup
      # ================================================================
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start infrastructure
        working-directory: examples
        run: docker compose up -d

      - name: Wait for orchestration health
        run: |
          echo "Waiting for orchestration service..."
          for i in $(seq 1 60); do
            if curl -sf http://localhost:8080/health > /dev/null 2>&1; then
              echo "Orchestration healthy after ${i}s"
              break
            fi
            if [ "$i" -eq 60 ]; then
              echo "Orchestration failed to start"
              docker compose -f examples/docker-compose.yml logs tasker-orchestration
              exit 1
            fi
            sleep 1
          done

      # ================================================================
      # FastAPI
      # ================================================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: pip install uv

      - name: Install FastAPI dependencies
        working-directory: examples/fastapi-app
        run: uv sync

      - name: Run FastAPI migrations
        working-directory: examples/fastapi-app
        env:
          APP_DATABASE_URL: postgresql://tasker:tasker@localhost:5432/example_fastapi
        run: uv run alembic upgrade head

      - name: Run FastAPI tests
        working-directory: examples/fastapi-app
        env:
          APP_DATABASE_URL: postgresql+asyncpg://tasker:tasker@localhost:5432/example_fastapi
          TASKER_CONFIG_PATH: app/config/worker.toml
          TASKER_TEMPLATE_PATH: app/config/templates
        run: uv run pytest tests/ -v

      # ================================================================
      # Bun
      # ================================================================
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Bun dependencies
        working-directory: examples/bun-app
        run: bun install

      - name: Run Bun migrations
        working-directory: examples/bun-app
        env:
          APP_DATABASE_URL: postgresql://tasker:tasker@localhost:5432/example_bun
        run: bun run db:migrate

      - name: Run Bun tests
        working-directory: examples/bun-app
        env:
          APP_DATABASE_URL: postgresql://tasker:tasker@localhost:5432/example_bun
          TASKER_CONFIG_PATH: src/config/worker.toml
          TASKER_TEMPLATE_PATH: src/config/templates
        run: bun test tests/

      # ================================================================
      # Rails
      # ================================================================
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true
          working-directory: examples/rails-app

      - name: Run Rails migrations
        working-directory: examples/rails-app
        env:
          APP_DATABASE_URL: postgresql://tasker:tasker@localhost:5432/example_rails
          RAILS_ENV: test
          TASKER_CONFIG_PATH: config/tasker/worker.toml
          TASKER_TEMPLATE_PATH: config/tasker/templates
        run: bundle exec rake db:migrate

      - name: Run Rails tests
        working-directory: examples/rails-app
        env:
          APP_DATABASE_URL: postgresql://tasker:tasker@localhost:5432/example_rails
          RAILS_ENV: test
          TASKER_CONFIG_PATH: config/tasker/worker.toml
          TASKER_TEMPLATE_PATH: config/tasker/templates
        run: bundle exec rspec spec/integration/ --format documentation

      # ================================================================
      # Axum
      # ================================================================
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install protobuf compiler
        run: |
          PROTOC_VERSION="28.3"
          curl -sLO "https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-linux-x86_64.zip"
          sudo unzip -o "protoc-${PROTOC_VERSION}-linux-x86_64.zip" -d /usr/local bin/protoc 'include/*'
          rm -f "protoc-${PROTOC_VERSION}-linux-x86_64.zip"
          protoc --version

      - name: Cache Rust build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: examples/axum-app

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Run Axum tests
        working-directory: examples/axum-app
        env:
          APP_DATABASE_URL: postgresql://tasker:tasker@localhost:5432/example_axum
          TASKER_CONFIG_PATH: config/worker.toml
          TASKER_TEMPLATE_PATH: config/templates
        run: cargo nextest run

      # ================================================================
      # Cleanup
      # ================================================================
      - name: Show docker logs on failure
        if: failure()
        working-directory: examples
        run: docker compose logs --tail=100

      - name: Stop infrastructure
        if: always()
        working-directory: examples
        run: docker compose down -v
