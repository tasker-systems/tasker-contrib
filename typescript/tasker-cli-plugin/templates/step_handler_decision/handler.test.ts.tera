import { describe, it, expect, vi } from 'vitest';
import { {{ name | pascal_case }}Handler } from '../{{ name | snake_case }}-handler';

describe('{{ name | pascal_case }}Handler', () => {
  const handler = new {{ name | pascal_case }}Handler();

  function makeContext(routeKey?: string) {
    return {
      taskUuid: crypto.randomUUID(),
      stepUuid: crypto.randomUUID(),
      inputData: routeKey ? { route_key: routeKey } : {},
      dependencyResults: {},
      stepConfig: {},
      stepInputs: {},
      retryCount: 0,
      maxRetries: 3,
      correlationId: crypto.randomUUID(),
      handlerName: '{{ name | snake_case }}',
      event: {} as any,
      getDependencyResult: vi.fn(),
      getInput: vi.fn((key: string) => {
        if (key === 'route_key') return routeKey;
        return undefined;
      }),
    } as any;
  }

  describe('decision routing', () => {
    it('routes to fast_track_processing', async () => {
      const result = await handler.call(makeContext('fast_track'));

      expect(result.success).toBe(true);
    });

    it('routes to manual_review and approval_gate', async () => {
      const result = await handler.call(makeContext('review_required'));

      expect(result.success).toBe(true);
    });

    it('routes to standard_processing by default', async () => {
      const result = await handler.call(makeContext());

      expect(result.success).toBe(true);
    });
  });
});
