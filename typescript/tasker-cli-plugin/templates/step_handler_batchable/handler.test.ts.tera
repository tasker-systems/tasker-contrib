import { describe, it, expect, vi } from 'vitest';
import { {{ name | pascal_case }}Handler } from '../{{ name | snake_case }}-handler';

describe('{{ name | pascal_case }}Handler', () => {
  const handler = new {{ name | pascal_case }}Handler();

  describe('analyzer mode', () => {
    it('creates batch configs', async () => {
      const context = {
        taskUuid: crypto.randomUUID(),
        stepUuid: crypto.randomUUID(),
        inputData: { total_items: 1000 },
        dependencyResults: {},
        stepConfig: { worker_count: 5 },
        stepInputs: {},
        retryCount: 0,
        maxRetries: 3,
        correlationId: crypto.randomUUID(),
        handlerName: '{{ name | snake_case }}',
        event: {} as any,
        getDependencyResult: vi.fn(),
        getInput: vi.fn(),
      } as any;

      const result = await handler.call(context);

      expect(result.success).toBe(true);
      expect(result.result?.batch_processing_outcome).toBeDefined();
    });
  });

  describe('worker mode', () => {
    it('processes a batch range', async () => {
      const context = {
        taskUuid: crypto.randomUUID(),
        stepUuid: crypto.randomUUID(),
        inputData: {},
        dependencyResults: {},
        stepConfig: {},
        stepInputs: {
          cursor: {
            batch_id: '001',
            start_cursor: 0,
            end_cursor: 200,
            batch_size: 200,
          },
          batch_context: {
            startCursor: 0,
            endCursor: 200,
            batchId: '001',
          },
        },
        retryCount: 0,
        maxRetries: 3,
        correlationId: crypto.randomUUID(),
        handlerName: '{{ name | snake_case }}',
        event: {} as any,
        getDependencyResult: vi.fn(),
        getInput: vi.fn(),
      } as any;

      const result = await handler.call(context);

      expect(result.success).toBe(true);
    });
  });
});
