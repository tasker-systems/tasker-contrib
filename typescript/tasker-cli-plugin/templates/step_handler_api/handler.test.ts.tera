import { describe, it, expect, vi, beforeEach } from 'vitest';
import { {{ name | pascal_case }}Handler } from '../{{ name | snake_case }}-handler';

describe('{{ name | pascal_case }}Handler', () => {
  const handler = new {{ name | pascal_case }}Handler();

  const mockContext = {
    taskUuid: crypto.randomUUID(),
    stepUuid: crypto.randomUUID(),
    inputData: { endpoint: '/users/1' },
    dependencyResults: {},
    stepConfig: {},
    stepInputs: {},
    retryCount: 0,
    maxRetries: 3,
    correlationId: crypto.randomUUID(),
    handlerName: '{{ name | snake_case }}',
    event: {} as any,
    getDependencyResult: vi.fn(),
    getInput: vi.fn(),
  } as any;

  describe('call', () => {
    it('returns a success result on HTTP 200', async () => {
      vi.stubGlobal('fetch', vi.fn().mockResolvedValue(
        new Response(JSON.stringify({ id: 1 }), { status: 200 }),
      ));

      const result = await handler.call(mockContext);
      expect(result.success).toBe(true);

      vi.unstubAllGlobals();
    });
  });

  describe('metadata', () => {
    it('has the correct handler name', () => {
      expect({{ name | pascal_case }}Handler.handlerName).toBe('{{ name | snake_case }}');
    });

    it('has the correct base URL', () => {
      expect({{ name | pascal_case }}Handler.baseUrl).toBe('{{ base_url }}');
    });
  });
});
