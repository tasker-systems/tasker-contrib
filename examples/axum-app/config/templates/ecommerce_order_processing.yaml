name: ecommerce_order_processing
namespace_name: ecommerce_rs
version: 1.0.0

task_handler:
  callable: "ecommerce_order_processing"

input_schema:
  type: object
  required:
    - cart_items
    - customer_info
    - payment_info
  properties:
    cart_items:
      type: array
      items:
        type: object
        required: [product_id, quantity]
        properties:
          product_id:
            type: integer
          quantity:
            type: integer
            minimum: 1
    customer_info:
      type: object
      required: [email, name]
      properties:
        email:
          type: string
          format: email
        name:
          type: string
    payment_info:
      type: object
      required: [method, token, amount]
      properties:
        method:
          type: string
        token:
          type: string
        amount:
          type: number
          minimum: 0
    shipping_address:
      type: object

steps:
  - name: validate_cart
    description: Validate cart items, check availability, and calculate pricing
    handler:
      callable: "ecommerce_validate_cart"
    dependencies: []
    retry:
      max_attempts: 2
      backoff_seconds: [1, 5]

  - name: process_payment
    description: Process payment through the payment gateway
    handler:
      callable: "ecommerce_process_payment"
    dependencies:
      - validate_cart
    retry:
      max_attempts: 3
      backoff_seconds: [2, 10, 30]

  - name: update_inventory
    description: Reserve inventory for the validated cart items
    handler:
      callable: "ecommerce_update_inventory"
    dependencies:
      - validate_cart
    retry:
      max_attempts: 3
      backoff_seconds: [1, 5, 15]

  - name: create_order
    description: Create the order record aggregating upstream results
    handler:
      callable: "ecommerce_create_order"
    dependencies:
      - process_payment
      - update_inventory
    retry:
      max_attempts: 2
      backoff_seconds: [2, 10]

  - name: send_confirmation
    description: Send order confirmation email to the customer
    handler:
      callable: "ecommerce_send_confirmation"
    dependencies:
      - create_order
    retry:
      max_attempts: 3
      backoff_seconds: [5, 15, 30]
